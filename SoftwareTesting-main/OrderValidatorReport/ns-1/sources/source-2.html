


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > LngLatHandler</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">uk.ac.ed.info</a>
</div>

<h1>Coverage Summary for Class: LngLatHandler (uk.ac.ed.info)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">LngLatHandler</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/10)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/60)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/68)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package uk.ac.ed.info;
&nbsp;
&nbsp;import com.fasterxml.jackson.databind.ObjectMapper;
&nbsp;import uk.ac.ed.inf.ilp.data.LngLat;
&nbsp;import uk.ac.ed.inf.ilp.data.NamedRegion;
&nbsp;import uk.ac.ed.inf.ilp.data.Order;
&nbsp;import uk.ac.ed.inf.ilp.interfaces.LngLatHandling;
&nbsp;import uk.ac.ed.inf.ilp.constant.SystemConstants;
&nbsp;
&nbsp;
&nbsp;import java.awt.*;
&nbsp;import java.io.IOException;
&nbsp;import java.math.BigDecimal;
&nbsp;import java.math.MathContext;
&nbsp;import java.net.URL;
&nbsp;import java.util.HashSet;
&nbsp;
&nbsp;import com.fasterxml.jackson.databind.ObjectMapper;
&nbsp;
&nbsp;import com.fasterxml.jackson.datatype.jsr310.JavaTimeModule;
&nbsp;
&nbsp;public class LngLatHandler implements LngLatHandling{
&nbsp;    NamedRegion[] noFlyZones;
<b class="nc">&nbsp;    public LngLatHandler(ServerHandler serverHandler){</b>
<b class="nc">&nbsp;        noFlyZones = serverHandler.getNoFlyZones();</b>
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    public LngLatHandler(ObjectMapper mapper){</b>
<b class="nc">&nbsp;        mapper.registerModule(new JavaTimeModule());</b>
&nbsp;
&nbsp;        try {
<b class="nc">&nbsp;            noFlyZones = mapper.readValue(new URL(&quot;http://localhost:8080&quot; + &quot;/noFlyZones&quot;), NamedRegion[].class);</b>
&nbsp;        } catch (IOException e) {
<b class="nc">&nbsp;            throw new RuntimeException(e);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;
&nbsp;    @Override
&nbsp;    public double distanceTo(LngLat p, LngLat q){
<b class="nc">&nbsp;        double latDis = p.lat() - q.lat();</b>
<b class="nc">&nbsp;        double lngDis = p.lng() - q.lng();</b>
&nbsp;
&nbsp;
&nbsp;
<b class="nc">&nbsp;        return Math.sqrt(Math.pow(latDis, 2) + Math.pow(lngDis, 2));</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public boolean isCloseTo(LngLat startPosition, LngLat otherPosition) {
<b class="nc">&nbsp;        return distanceTo(startPosition, otherPosition) &lt;= SystemConstants.DRONE_IS_CLOSE_DISTANCE;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public LngLat nextPosition(LngLat startPosition, double angle) {
&nbsp;        //check for negatives?
<b class="nc">&nbsp;        if (angle == 999) return startPosition;</b>
&nbsp;
<b class="nc">&nbsp;        if((angle % 22.5) != 0 ) throw new IllegalArgumentException(&quot;angle must be one of the 16 major compass directions&quot;);</b>
&nbsp;
<b class="nc">&nbsp;        angle %= 360;</b>
&nbsp;
<b class="nc">&nbsp;        if(angle == 0) return new LngLat(startPosition.lng()+ SystemConstants.DRONE_MOVE_DISTANCE, startPosition.lat());</b>
&nbsp;
&nbsp;        double xdis;
&nbsp;        double ydis;
&nbsp;        double theta;
<b class="nc">&nbsp;        if(angle &lt;= 90){</b>
<b class="nc">&nbsp;            theta = angle;</b>
&nbsp;
<b class="nc">&nbsp;            xdis = Adj(theta, SystemConstants.DRONE_MOVE_DISTANCE);</b>
<b class="nc">&nbsp;            ydis = Opp(theta, SystemConstants.DRONE_MOVE_DISTANCE);</b>
<b class="nc">&nbsp;        } else if (angle &lt;= 180) {</b>
<b class="nc">&nbsp;            theta = angle - 90;</b>
&nbsp;
<b class="nc">&nbsp;            xdis = -Opp(theta, SystemConstants.DRONE_MOVE_DISTANCE);</b>
<b class="nc">&nbsp;            ydis = Adj(theta, SystemConstants.DRONE_MOVE_DISTANCE);</b>
<b class="nc">&nbsp;        } else if (angle &lt;= 270) {</b>
<b class="nc">&nbsp;            theta = angle -180;</b>
&nbsp;
<b class="nc">&nbsp;            xdis = -Adj(theta, SystemConstants.DRONE_MOVE_DISTANCE);</b>
<b class="nc">&nbsp;            ydis = -Opp(theta, SystemConstants.DRONE_MOVE_DISTANCE);</b>
<b class="nc">&nbsp;        } else if (angle &lt;= 360) {</b>
<b class="nc">&nbsp;            theta = angle - 270;</b>
&nbsp;
<b class="nc">&nbsp;            xdis = Adj(theta, SystemConstants.DRONE_MOVE_DISTANCE);</b>
<b class="nc">&nbsp;            ydis = -Opp(theta, SystemConstants.DRONE_MOVE_DISTANCE);</b>
<b class="nc">&nbsp;        }else throw new IllegalArgumentException(&quot;input angle must be below 360 unless hovering&quot;);</b>
&nbsp;
<b class="nc">&nbsp;        return new LngLat(startPosition.lng() + xdis, startPosition.lat() + ydis);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public boolean isInRegion(LngLat position, NamedRegion region) {
<b class="nc">&nbsp;        HashSet&lt;LngLat&gt; interCount = new HashSet&lt;&gt;();</b>
<b class="nc">&nbsp;        interCount.add(null);</b>
<b class="nc">&nbsp;        int totalV = region.vertices().length;</b>
&nbsp;
<b class="nc">&nbsp;        for(int i=0; i &lt; totalV; i++){</b>
<b class="nc">&nbsp;            LngLat intersection = intersects(position, region.vertices()[i],region.vertices()[(i+1)%totalV]);</b>
&nbsp;            // make number of intersections the sum of unique intersection points
&nbsp;
<b class="nc">&nbsp;            if(intersection != null &amp;&amp; intersection.equals(new LngLat(999,999))) return true;</b>
<b class="nc">&nbsp;            interCount.add(intersection);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        return ((interCount.size()-1) % 2) == 1;</b>
&nbsp;    }
&nbsp;
&nbsp;    public boolean isInNoFly(LngLat pos){
&nbsp;
<b class="nc">&nbsp;        for(NamedRegion r : noFlyZones) {</b>
<b class="nc">&nbsp;            if(isInRegion(pos,r)) return true;</b>
&nbsp;        }
<b class="nc">&nbsp;        return false;</b>
&nbsp;    }
&nbsp;
&nbsp;
&nbsp;
&nbsp;    //checks if a horizontal line cast from start to the right infinitely intersects line from vert1 to vert 2
&nbsp;    private LngLat intersects(LngLat start, LngLat Vert1, LngLat Vert2){ //returns 0 if false 1 if true and -1 if on line
<b class="nc">&nbsp;        if(Vert1.lat() == Vert2.lat()){ // line is horizontal</b>
<b class="nc">&nbsp;            return null;</b>
&nbsp;            //the horizontal cast line cannot intersect or start on another horizontal line for the sake of this function
<b class="nc">&nbsp;        } else if (Vert1.lng() == Vert2.lng()) { // line is vertical</b>
<b class="nc">&nbsp;            if((Math.min(Vert1.lat(), Vert2.lat()) &lt;= start.lat()) &amp; (start.lat() &lt;= Math.max(Vert1.lat(), Vert2.lat()))){</b>
<b class="nc">&nbsp;                if(start.lng() &gt; Vert1.lng()) return null;</b>
<b class="nc">&nbsp;                else if (start.lng() &lt; Vert1.lng()) return new LngLat(Vert1.lng(), start.lat());</b>
&nbsp;
<b class="nc">&nbsp;                return new LngLat(999,999); //must be on line so return special value</b>
&nbsp;            }
<b class="nc">&nbsp;            return null;</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        double m = (Vert2.lat() - Vert1.lat())/(Vert2.lng() - Vert1.lng());</b>
<b class="nc">&nbsp;        double c = -m* Vert1.lng() + Vert1.lat();</b>
&nbsp;
&nbsp;        //if((Math.min(Vert1.lat(), Vert2.lat()) &lt;= start.lat()) &amp; (start.lat() &lt;= Math.max(Vert1.lat(), Vert2.lat()))){
<b class="nc">&nbsp;        if((Math.min(Vert1.lat(), Vert2.lat()) &lt;= start.lat()) &amp; (start.lat() &lt;= Math.max(Vert1.lat(), Vert2.lat()))){</b>
<b class="nc">&nbsp;            double interX = (double) Math.round((start.lat() - c) / m * 1000000000) /1000000000; //requires rounding to cover rounding errors</b>
<b class="nc">&nbsp;            double startLngRounded = (double) Math.round(start.lng() * 1000000000) /1000000000;</b>
&nbsp;            //if(interX &lt; start.lng()){
<b class="nc">&nbsp;            if(interX &lt; startLngRounded){</b>
&nbsp;                //intersection is to the left of point so not counted
<b class="nc">&nbsp;                return null;</b>
<b class="nc">&nbsp;            } else if (interX &gt; startLngRounded) {</b>
&nbsp;                // intersection to right so it is counted
<b class="nc">&nbsp;                return new LngLat(interX, start.lat());</b>
&nbsp;            }
&nbsp;            //must be on line then so
<b class="nc">&nbsp;            return start;</b>
&nbsp;        }
<b class="nc">&nbsp;        return null;</b>
&nbsp;
&nbsp;    }
&nbsp;
&nbsp;    private double Adj(double theta, double hyp){
&nbsp;
<b class="nc">&nbsp;        if(theta == 90 || theta == 270){</b>
<b class="nc">&nbsp;            return 0;</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        return Math.cos(Math.toRadians(theta))*hyp;</b>
&nbsp;
&nbsp;    }
&nbsp;
&nbsp;    private double Opp(double theta, double hyp){
<b class="nc">&nbsp;        if(theta == 0 || theta == 180){</b>
<b class="nc">&nbsp;            return 0;</b>
&nbsp;        }
<b class="nc">&nbsp;        return Math.sin(Math.toRadians(theta))*hyp;</b>
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2025-01-20 14:52</div>
</div>
</body>
</html>
